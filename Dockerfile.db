FROM postgres:15

# Install Python and required packages
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-psycopg2 \
    postgresql-15-cron \
    && rm -rf /var/lib/apt/lists/*

# Copy initialization scripts
COPY app/init_db.py /docker-entrypoint-initdb.d/
COPY app/01-init-db.sh /docker-entrypoint-initdb.d/

# Copy and set up PostgreSQL configuration
COPY postgresql.conf /etc/postgresql/postgresql.conf
RUN chown postgres:postgres /etc/postgresql/postgresql.conf && \
    chmod 600 /etc/postgresql/postgresql.conf

# Grant permissions for initialization scripts
RUN chmod -R 755 /docker-entrypoint-initdb.d

# Set work directory
WORKDIR /docker-entrypoint-initdb.d

# Start PostgreSQL with custom config
CMD ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
